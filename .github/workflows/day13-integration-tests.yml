# Day 13 â€” CI Integration Test Configuration

name: Day 13 Integration Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  integration-tests:
    runs-on: ubuntu-latest
    
    timeout-minutes: 30
    
    services:
      mongodb:
        image: mongo:6
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.adminCommand({ ping: 1 })'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: ethixai
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: |
            backend/package-lock.json
            frontend/package-lock.json
            tools/e2e/package-lock.json
            tools/integration/package-lock.json
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'
          cache-dependency-path: |
            backend/requirements.txt
            ai_core/requirements.txt
      
      - name: Install backend dependencies
        working-directory: ./backend
        run: npm ci
      
      - name: Install ai_core dependencies
        working-directory: ./ai_core
        run: pip install -r requirements.txt
      
      - name: Install test dependencies
        run: |
          cd tools/e2e && npm ci
          cd ../integration && npm ci
      
      - name: Start backend service
        working-directory: ./backend
        env:
          MONGO_URL: mongodb://localhost:27017/ethixai
          PORT: 5000
        run: |
          npm start &
          echo $! > backend.pid
          sleep 10
      
      - name: Start ai_core service
        working-directory: ./ai_core
        env:
          MONGO_URL: mongodb://localhost:27017/ethixai
        run: |
          set -euo pipefail
          # Start using uvicorn (background) and capture logs to a file so we can upload them on failure
          nohup uvicorn main:app --host 0.0.0.0 --port 8100 > aicore.log 2>&1 &
          echo $! > aicore.pid
          echo "started ai_core (pid=$(cat aicore.pid)), tailing first lines of aicore.log"
          head -n 200 aicore.log || true
          # wait for health endpoint to become available (fail early with logs if not)
          timeout 60 bash -c 'until curl -fsS http://localhost:8100/health >/dev/null 2>&1; do sleep 2; done' || (echo "ai_core failed to start within 60s"; echo "--- aicore.log ---"; tail -n 500 aicore.log || true; echo "--- ps aux (uvicorn) ---"; ps aux | egrep "uvicorn|main:app" || true; exit 1)
      
      - name: Wait for services
        run: |
          timeout 60 bash -c 'until curl -fsS http://localhost:5000/health; do sleep 2; done'
          timeout 60 bash -c 'until curl -fsS http://localhost:8100/health; do sleep 2; done'
      
      - name: Run E2E User Journey Tests
        working-directory: ./tools/e2e
        run: npm run test:journey
        continue-on-error: true
      
      - name: Run Observability Tests
        working-directory: ./tools/integration
        run: npm run test:observability
        continue-on-error: true
      
      - name: Run Compatibility Tests
        working-directory: ./tools/integration
        run: bash compatibility_tests.sh
        continue-on-error: true
      
      - name: Collect logs on failure
        if: failure()
        run: |
          mkdir -p test-artifacts
          echo "=== backend log ==="
          cat backend/backend.log || echo "No backend log"
          echo "=== ai_core log ==="
          cat ai_core/aicore.log || echo "No ai_core log"
          echo "=== process list ==="
          ps aux | head -n 200 || true
          echo "=== docker ps (if any) ==="
          docker ps --no-trunc || true
      
      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results
          path: |
            tmp/day13/
            test-artifacts/
          retention-days: 7
      
      - name: Stop services
        if: always()
        run: |
          kill $(cat backend/backend.pid) || true
          kill $(cat ai_core/aicore.pid) || true

  failure-drills:
    runs-on: ubuntu-latest
    needs: integration-tests
    
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      
      - name: Start services with Docker Compose
        run: docker compose up -d --build
      
      - name: Wait for services
        run: |
          timeout 120 bash -c 'until curl -fsS http://localhost:5000/health; do sleep 5; done'
          timeout 120 bash -c 'until curl -fsS http://localhost:8100/health; do sleep 5; done'
      
      - name: Install test dependencies
        working-directory: ./tools/integration
        run: npm ci
      
      - name: Run Failure Drills
        working-directory: ./tools/integration
        run: npm run test:failure
        continue-on-error: true
      
      - name: Run Resilience Tests
        working-directory: ./tools/integration
        run: npm run test:resilience
        continue-on-error: true
      
      - name: Collect service logs
        if: always()
        run: |
          docker compose logs system_api > backend-logs.txt
          docker compose logs ai_core > aicore-logs.txt
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: failure-drill-results
          path: |
            tmp/day13/
            backend-logs.txt
            aicore-logs.txt
          retention-days: 7
      
      - name: Stop services
        if: always()
        run: docker compose down -v

  generate-report:
    runs-on: ubuntu-latest
    needs: [integration-tests, failure-drills]
    if: always()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
      
      - name: Generate consolidated report
        run: |
          mkdir -p docs/reports
          echo "# Day 13 CI Integration Test Report" > docs/reports/ci-integration-report.md
          echo "" >> docs/reports/ci-integration-report.md
          echo "**Date:** $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> docs/reports/ci-integration-report.md
          echo "**Workflow:** ${{ github.workflow }}" >> docs/reports/ci-integration-report.md
          echo "**Run:** ${{ github.run_number }}" >> docs/reports/ci-integration-report.md
          echo "" >> docs/reports/ci-integration-report.md
          echo "## Test Results" >> docs/reports/ci-integration-report.md
          echo "" >> docs/reports/ci-integration-report.md
          echo "View detailed results in workflow artifacts." >> docs/reports/ci-integration-report.md
      
      - name: Upload report
        uses: actions/upload-artifact@v4
        with:
          name: ci-integration-report
          path: docs/reports/ci-integration-report.md
          retention-days: 30
